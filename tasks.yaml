tasks:
  - name: set-modules-variable
    actions:
      - cmd: echo $(find . -type f -name 'go.mod' -exec dirname {} \; | cut -c 3-)
        setVariables:
          - name: MODULES

  # This could be improved if something like this was introduced https://github.com/defenseunicorns/maru-runner/issues/17
  - name: build-pkg
    description: build specified package
    actions:
      - cmd: cd "${PKG}" &&  go build .
        description: "build pkg"

  # Including a build step for codeQL
  - name: build-all
    description: build all packages
    actions:
      - task: set-modules-variable
      - cmd: |
          for dir in ${MODULES}; do
            uds run build-pkg --set PKG=$dir
          done
        description: build all

  - name: test-pkg
    description: Run unit tests for one package
    actions:
      - cmd: cd "${PKG}" && go test ./...

  - name: test-all
    description: Run unit tests in all packages
    actions:
      - task: set-modules-variable
      - cmd: |
          for dir in ${MODULES}; do
            uds run test-pkg --set PKG=$dir
          done

  - name: lint-pkg
    description: lint package
    actions:
      - cmd: cd "${PKG}" && revive -config ../revive.toml ./...

  - name: lint-all
    description: lint all packages
    actions:
      - cmd: revive ./...

  - name: scan-cves
    description: lint all packages
    actions:
      - task: set-modules-variable
      - cmd: |
          syft scan . -o json | grype --fail-on low
