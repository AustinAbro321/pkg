name: install-tools
description: "Install pipeline tools"
inputs:
  module:
    description: "The module to be released"
    required: true

runs:
  using: composite
  steps:
    - name: bump module version
      id: module-tag
      run: |
        git fetch --tags origin
        cd internal/release
        echo "new-version=$(go run main.go ${{ inputs.module }})" >> $GITHUB_OUTPUT
      shell: bash

    - name: install git cliffs
      env:
        # renovate: datasource=github-tags depName=orhun/git-cliff versioning=semver
        VERSION: 2.1.2
      run: |
        curl --location --output /tmp/git-cliffs.tar.gz https://github.com/orhun/git-cliff/releases/download/v${VERSION}/git-cliff-${VERSION}-x86_64-unknown-linux-gnu.tar.gz
        tar -xvzf /tmp/git-cliffs.tar.gz -C /tmp
        mv /tmp/git-cliff-${VERSION}/git-cliff /usr/local/bin/
      shell: bash

    # - name: generate release notes
    #   run: |
    #     git cliff --tag ${{ steps.module-tag.outputs.new-version }} > notes.txt
    #   shell: bash

    - name: Generate a changelog
      uses: orhun/git-cliff-action@main
      id: git-cliff
      with:
        config: cliff.toml
        args: -v --latest --include-path "${{ inputs.module }}/*"  --no-exec --github-repo ${{ github.repository }}
      env:
        OUTPUT: CHANGES.md

    - name: Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        cat CHANGES.md
        gh release create ${{ steps.module-tag.outputs.new-version }} --notes-file CHANGES.md
      shell: bash
